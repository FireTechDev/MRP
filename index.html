<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MRP</title>
  <!-- PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Message radio Pompier">
  <link rel="icon" type="image/png" href="icons/192.png">
  <link rel="apple-touch-icon" href="icons/192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/512.png">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <style>
    @font-face {
      font-family: 'Material Icons';
      font-style: normal;
      font-weight: 400;
      src: url('icons/material-icons.woff2') format('woff2');
    }

    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
    }

    .progress-step::before {
      content: '';
      width: 32px;
      height: 32px;
      background: transparent;
      border-radius: 50%;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Material Icons';
      font-size: 24px;
      line-height: 1;
      -webkit-font-smoothing: antialiased;
    }

    .progress-step[data-step="inter"]::before {
      content: 'description';
    }

    .progress-step[data-step="je-suis"]::before {
      content: 'my_location';
    }

    .progress-step[data-step="je-vois"]::before {
      content: 'visibility';
    }

    .progress-step[data-step="victimes"]::before {
      content: 'personal_injury';
    }

    .progress-step[data-step="je-fais"]::before {
      content: 'touch_app';
    }

    .progress-step[data-step="je-demande"]::before {
      content: 'local_fire_department';
    }

    .progress-step[data-step="message"]::before {
      content: 'phone_android';
    }

    :root {
      --primary-color: #007BFF;
      --secondary-color: #6c757d;
      --background-color: #f8f9fa;
      --text-color: #333;
      --border-color: #dee2e6;
      --danger-color: red;
      --container-bg: #fff;
      --box-shadow: 0 0 8px rgba(0,0,0,0.2);
      --border-radius: 8px;
      --font-family: Arial, sans-serif;
      --font-size: 18px;
      --padding: 15px;
      --margin: 10px;
    }

    /* Base styles */
    body {
      font-family: var(--font-family);
      margin: 0;
      padding: var(--margin);
      background: var(--background-color);
      font-size: var(--font-size);
      line-height: 1.5;
    }

    /* Layout */
    .container {
      max-width: 100%;
      margin: 0;
      background: transparent;
      padding: var(--padding);
      box-shadow: none;
      border-radius: 0;
    }

    /* Typography */
    h1, h3, h4 {
      margin: 15px 0 10px;
      color: #333;
    }

    h1 {
      text-align: center;
      font-size: 1.2rem;
      margin: 0.5rem 0;
    }

    h3 {
      font-size: 1rem;
      font-weight: 500;
    }

    h4 {
      font-size: 0.9rem;
      font-weight: 500;
    }

    /* Form elements */
    input, select, textarea, button, .toggle-btn {
      width: 100%;
      padding: var(--padding);
      margin: 8px 0;
      box-sizing: border-box;
      font-size: var(--font-size);
      border-radius: 5px;
      font-family: var(--font-family);
    }

    button, .toggle-btn {
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    button {
      background-color: var(--primary-color);
      color: #fff;
    }

    .toggle-btn {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(0, 123, 255, 0.05);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .toggle-btn:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    .toggle-btn.selected, #toggleRouteBtn.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .prev-btn { background-color: grey; }
    .reset-btn { background-color: var(--danger-color); }
    
    /* Progress bar */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin: 0 calc(-1 * var(--padding));
      margin-bottom: 15px;
      background: transparent;
      padding: 8px var(--padding);
      box-shadow: none;
    }

    .progress-step {
      flex: 1;
      padding: 8px 2px;
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      border-bottom: 3px solid #ddd;
      cursor: pointer;
      white-space: nowrap;
      text-transform: lowercase;
      color: #666;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .progress-step.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }

    .progress-step.active::before {
      color: var(--primary-color);
      border-radius: 50%;
    }

    @media (max-width: 480px) {
      .progress-step {
        font-size: 14px;
        padding: 6px 1px;
      }
    }

    /* Controls */
    .number-control {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .number-control button {
      width: 30%;
    }

    .number-control input {
      width: 40%;
      text-align: center;
    }

    /* States and containers */
    .hidden { display: none !important; }
    
    .step {
      display: none;
      animation: fadeIn 0.5s;
    }

    .step.active { display: block; }

    /* Style pour les sections de risque */
    .risk-section {
      margin: 4px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    /* Style pour les sous-conteneurs */
    .sub-container {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }

    /* Style sp√©cifique pour le formulaire AVP */
    #avpFields {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Toggle elements */
    .toggle-btn.selected, #toggleRouteBtn.active {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .toggle-icon {
      display: inline-block;
      font-size: 20px;
      font-weight: bold;
      margin-left: 5px;
      transition: transform 0.3s;
    }

    .toggle-icon.rotated {
      transform: rotate(90deg);
    }

    /* Info elements */
    .info-text {
      background: #e9ecef;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }

    .result {
      composes: info-text;
      margin-top: 15px;
      white-space: pre-wrap;
      font-family: var(--font-family);
      font-size: var(--font-size);
      line-height: 1.5;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .progress-step {
        font-size: 10px;
        padding: 3px;
      }
      
      input, select, textarea, button {
        font-size: 16px;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Update button styles */
    .update-container {
      text-align: center;
      margin: 20px auto;
      max-width: 600px;
      color: #666;
      font-size: 14px;
    }
    
    .offline-info {
      margin-bottom: 5px;
    }
    
    .update-link {
      color: #007BFF;
      text-decoration: none;
      font-size: 13px;
    }
    
    .update-link:hover {
      text-decoration: underline;
    }
    
    .update-status {
      margin-top: 5px;
      color: #28a745;
      font-size: 13px;
      display: none;
    }
    
    .version-info {
      color: #666;
      font-size: 13px;
      margin-left: 5px;
    }

    /* Toggle buttons for address confirmation */
    .address-toggle-container {
      display: flex;
      width: 100%;
      margin: 8px 0;
      border: 1px solid var(--primary-color);
      border-radius: 5px;
      overflow: hidden;
      background: #f8f9fa;
    }

    .address-toggle-btn {
      flex: 1;
      padding: 12px;
      border: none;
      background: transparent;
      color: #999;
      font-size: var(--font-size);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      margin: 0;
    }

    .address-toggle-btn.selected {
      background: white;
      color: var(--primary-color);
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .address-toggle-btn:not(.selected) {
      background: transparent;
    }

    .address-toggle-btn:first-child {
      border-right: 1px solid var(--primary-color);
    }

    .gps-btn {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(0, 123, 255, 0.05);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      color: var(--primary-color);
      font-size: var(--font-size);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .gps-btn:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    .secondary-btn {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      background: rgba(0, 123, 255, 0.05);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      color: var(--primary-color);
      font-size: var(--font-size);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .secondary-btn:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    .gps-icon {
      margin-right: 5px;
    }

    .gps-info {
      font-size: 12px;
      color: #666;
      margin-top: -5px;
      margin-bottom: 5px;
      font-style: italic;
    }

    /* Style sp√©cifique pour les boutons des sections victimes, je fais, je demande */
    #victimsToggleContainer .toggle-btn,
    #actionsContainer .toggle-btn,
    #demandeActions .toggle-btn,
    #prevoisActions .toggle-btn,
    #natureInterventionContainer .toggle-btn {
      background: rgba(0, 123, 255, 0.05);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    #victimsToggleContainer .toggle-btn:hover,
    #actionsContainer .toggle-btn:hover,
    #demandeActions .toggle-btn:hover,
    #prevoisActions .toggle-btn:hover,
    #natureInterventionContainer .toggle-btn:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    #victimsToggleContainer .toggle-btn.selected,
    #actionsContainer .toggle-btn.selected,
    #demandeActions .toggle-btn.selected,
    #prevoisActions .toggle-btn.selected,
    #natureInterventionContainer .toggle-btn.selected {
      background-color: var(--primary-color);
      color: white;
    }

    /* Style pour le bouton "Je pr√©vois" */
    #togglePrevoisBtn {
      background: rgba(0, 123, 255, 0.05);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
    }

    #togglePrevoisBtn:hover {
      background: rgba(0, 123, 255, 0.1);
    }

    #togglePrevoisBtn.active {
      background-color: var(--primary-color);
      color: white;
    }

    .copyright {
      margin-top: 20px;
      font-size: 12px;
      color: #999;
    }

    /* Ajout des styles pour le nouveau compteur */
    .vehicle-count {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    .vehicle-count-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 8px;
    }

    .vehicle-count label {
      margin: 0;
      color: #333;
      font-size: 16px;
      font-weight: normal;
      flex: 1;
    }

    .vehicle-count .counter-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .vehicle-count .counter-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: #007BFF;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      padding: 0;
      line-height: 1;
    }

    .vehicle-count .counter-btn:hover {
      background: #0056b3;
    }

    .vehicle-count .counter-btn.minus {
      background-color: #007BFF;
    }

    .vehicle-count .counter-btn.minus.disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .vehicle-count .counter-btn.plus {
      background-color: #007BFF;
    }

    .vehicle-count .counter-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      border: none;
      background: transparent;
      width: auto;
      margin: 0;
      padding: 0;
      text-align: center;
      min-width: 30px;
    }

    .vehicle-count .counter-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .vehicle-count-details {
      width: 100%;
      margin-top: 8px;
    }

    .vehicle-count-details select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    #vehiculeLegerDetails,
    #poidsLourdDetails,
    #deuxRouesDetails,
    #busDetails {
      margin-top: 10px;
      width: 100%;
      clear: both;
      display: block;
    }

    #vehiculeLegerDetails input,
    #poidsLourdDetails input,
    #deuxRouesDetails input,
    #busDetails input {
      width: 100%;
      margin-top: 10px;
      display: block;
    }

    /* Style pour les sections de risque */
    .risk-section {
      margin: 8px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .risk-section h4 {
      margin-bottom: 5px;
      color: #333;
    }

    #propagationVehiculeContainer,
    #isoleVehiculeContainer {
      display: flex;
      gap: 8px;
      margin-bottom: 5px;
    }

    #propagationVehiculeDetails,
    #isoleVehiculeDetails {
      margin-top: 5px;
    }

    #propagationVehiculeDetails input,
    #isoleVehiculeDetails input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    /* Style pour les tags de suggestion */
    .suggestion-tag {
      display: inline-block;
      background-color: rgba(0, 123, 255, 0.1);
      color: var(--primary-color);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 8px;
      border: 1px solid var(--primary-color);
    }

    /* Style pour le lien toggle */
    .link-toggle {
      color: var(--primary-color);
      text-decoration: none;
      cursor: pointer;
      display: inline-block;
      margin: 10px 0;
    }

    .link-toggle:hover {
      text-decoration: underline;
    }

    .vehicle-count label {
      display: flex;
      align-items: center;
    }

    /* Style pour les boutons avec tags */
    .toggle-btn {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .toggle-btn .suggestion-tag {
      position: absolute;
      right: 8px;
      margin: 0;
    }

    /* Ajout du style pour la section des victimes */
    #victimsFields {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    /* Ajout du style pour la section des moyens pompiers */
    #moyensPompiers {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .app-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px 0;
    }

    .app-icon {
      width: 64px;
      height: 64px;
      margin-bottom: 10px;
      border-radius: 50%;
      object-fit: cover;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .app-name {
      font-size: 24px;
      font-weight: bold;
      margin: 5px 0;
    }

    .version-info {
      font-size: 14px;
      color: #666;
      margin: 5px 0;
    }

    .update-container {
      text-align: center;
      margin-top: 20px;
      padding: 20px;
    }

    .offline-info {
      margin-bottom: 10px;
    }

    .update-link {
      display: block;
      margin: 10px 0;
      color: #0066cc;
      text-decoration: none;
    }

    .copyright {
      margin-top: 20px;
      font-size: 12px;
      color: #666;
    }

    /* Style pour les sections de risque dans le feu de v√©hicule */
    .vehicle-risk-section {
      margin: 2px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    /* Styles existants */
    
    .divider {
      height: 1px;
      background-color: #e0e0e0; /* Gris clair */
      margin: 16px 0;
    }

    .next-button {
      margin-top: 32px !important; /* Ajout d'espace au-dessus des boutons Suivant uniquement */
    }

    .navigation-buttons {
      margin-top: 32px;
    }

    /* Animation pour le swipe */
    .step {
      transition: transform 0.3s ease-out;
    }

    .step.swiping-left {
      transform: translateX(-100%);
    }

    .step.swiping-right {
      transform: translateX(100%);
    }

    .step.swipe-in-left {
      animation: swipeInLeft 0.3s ease-out;
    }

    .step.swipe-in-right {
      animation: swipeInRight 0.3s ease-out;
    }

    @keyframes swipeInLeft {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes swipeInRight {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Barre de progression -->
    <div class="progress-bar">
      <div class="progress-step active" data-step="inter" onclick="goToStep(0)">inter</div>
      <div class="progress-step" data-step="je-suis" onclick="goToStep(1)">je suis</div>
      <div class="progress-step" data-step="je-vois" onclick="goToStep(2)">je vois</div>
      <div class="progress-step" data-step="victimes" onclick="goToStep(3)">victimes</div>
      <div class="progress-step" data-step="je-fais" onclick="goToStep(4)">je fais</div>
      <div class="progress-step" data-step="je-demande" onclick="goToStep(5)">je demande</div>
      <div class="progress-step" data-step="message" onclick="goToStep(6)">message</div>
    </div>

    <!-- √âtape 0 : Intervention -->
    <div id="step0" class="step active">
      <label for="interventionNumber">Intervention num√©ro</label>
      <input type="text" id="interventionNumber" class="form-control" onkeypress="return event.charCode >= 48 && event.charCode <= 57" pattern="[0-9]*" onchange="updateMessage()">

      <label for="motifDepart">Motif de d√©part</label>
      <select id="motifDepart">
        <option value="">Choisir</option>
        <option>AVP</option>
        <option>Feu de v√©hicule</option>
        <option>Feu de b√¢timent</option>
        <option>Chute de ligne √©lectrique</option>
        <option>Odeur de brul√©</option>
        <option>Fum√©e suspecte</option>
        <option>Fuite de Gaz proc√©dure classique</option>
        <option>Fuite de Gaz proc√©dure renforc√©e</option>
        <option>D√©clenchement alarme</option>
        <option>Autre type d'intervention</option>
      </select>

      <div class="form-group">
        <label for="groupeHoraireAuto">Groupe horaire</label>
        <input type="time" id="groupeHoraireAuto" name="groupeHoraireAuto" onchange="updateMessage()">
        <button type="button" class="secondary-btn" onclick="setCurrentTime()">Actualiser l'heure</button>
      </div>

      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(0)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="goToStep(1)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âtape 1 : Je suis -->
    <div id="step1" class="step hidden">
      <div class="address-toggle-container">
        <button type="button" class="address-toggle-btn selected" onclick="selectAddressToggle(this, 'Confirm√©e')">Adresse confirm√©e</button>
        <button type="button" class="address-toggle-btn" onclick="selectAddressToggle(this, 'Modifi√©e')">Adresse modifi√©e</button>
      </div>
      <input type="hidden" id="adresseConfirmee" value="Confirm√©e">

      <button type="button" onclick="geolocalise()" class="gps-btn">
        G√©olocaliser ma position
      </button>

      <div class="field-group">
        <label for="adresse">Adresse</label>
        <input type="text" id="adresse" placeholder="Saisissez une adresse">
        <span id="gpsInfo" class="gps-info hidden">Position approximative bas√©e sur le GPS du navigateur.</span>
      </div>

      <div class="field-group">
      <label for="commune">Commune</label>
      <input type="text" id="commune" placeholder="Saisissez une commune">
        <span id="gpsInfoCommune" class="gps-info hidden">Position approximative bas√©e sur le GPS du navigateur.</span>
      </div>

      <button type="button" id="toggleRouteBtn" class="toggle-btn" onclick="toggleRouteInfo()">
        Informations route
        <span class="toggle-icon">‚Ä∫</span>
      </button>

      <div id="routeInfo" class="sub-container hidden">
      <label for="typeRoute">Type de route</label>
      <select id="typeRoute">
        <option value="">Choisir</option>
        <option>Autoroute</option>
        <option>Route nationale</option>
        <option>Route d√©partementale</option>
        <option>Rocade int√©rieure</option>
        <option>Rocade ext√©rieure</option>
      </select>

      <label for="numeroRoute">Num√©ro de route</label>
      <input type="text" id="numeroRoute" class="form-control" onkeypress="return event.charCode >= 48 && event.charCode <= 57" pattern="[0-9]*" placeholder="Saisissez num√©ro de route">

      <label for="nomEchangeur">Nom de l'√©changeur</label>
      <input type="text" id="nomEchangeur" placeholder="Saisissez le nom de l'√©changeur">

      <label for="pk">PK</label>
      <input type="text" id="pk" class="form-control" onkeypress="return event.charCode >= 48 && event.charCode <= 57" pattern="[0-9]*" placeholder="Saisissez num√©ro PK">

      <label for="sens">Sens</label>
      <input type="text" id="sens" placeholder="Saisissez un sens">
      </div>

      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(0)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="goToStep(2)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âtape 2 : Je vois -->
    <div id="step2" class="step hidden">
      <div id="natureInterventionContainer">
        <button type="button" class="toggle-btn nature-toggle" data-value="AVP" onclick="selectNature(this)">AVP</button>
        <button type="button" class="toggle-btn nature-toggle" data-value="Feu de v√©hicule" onclick="selectNature(this)">Feu de v√©hicule</button>
        <button type="button" class="toggle-btn nature-toggle" data-value="Feu de b√¢timent" onclick="selectNature(this)">Feu de b√¢timent</button>
        <button type="button" class="toggle-btn nature-toggle" data-value="Autre" onclick="selectNature(this)">Autre type d'intervention</button>
      </div>

      <h3 id="selectedNatureTitle" class="hidden" style="margin-top: 20px; text-align: center; color: #333; border-bottom: 2px solid #007BFF; padding-bottom: 10px;"></h3>

      <!-- Box pour Autre type d'intervention -->
      <div id="autreTypeBox" class="sub-container hidden">
        <label for="autreTypeIntervention">Autre type d'intervention</label>
        <select id="autreTypeIntervention" onchange="handleAutreIntervention(this.value)">
          <option value="">Choisir</option>
          <option value="Chute de ligne √©lectrique">Chute de ligne √©lectrique</option>
          <option value="Fuite de gaz proc√©dure classique">Fuite de gaz proc√©dure classique</option>
          <option value="Fuite de gaz proc√©dure renforc√©e">Fuite de gaz proc√©dure renforc√©e</option>
          <option value="Fum√©e suspecte">Fum√©e suspecte</option>
          <option value="Odeur de brul√©">Odeur de brul√©</option>
          <option value="Autre type de feu">Autre type de feu</option>
        </select>
      </div>

      <!-- Champs AVP -->
      <div id="avpFields" class="sub-container hidden">
        
        <!-- V√©hicule l√©ger -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>V√©hicule l√©ger</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('vehiculeLeger')" id="vehiculeLegerMinus">‚àí</button>
              <span class="counter-value" id="vehiculeLeger">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('vehiculeLeger')">+</button>
            </div>
          </div>
          <div id="vehiculeLegerDetails" class="vehicle-count-details hidden">
            <select id="vehiculeLegerEnergie">
              <option value="">Choisir l'√©nergie</option>
              <option>Essence</option>
              <option>Gazoil</option>
              <option>√âlectrique</option>
              <option>Hybride</option>
              <option>GPL</option>
              <option>Hydrog√®ne</option>
              <option>Inconnue</option>
            </select>
          </div>
        </div>

        <!-- Poids lourd -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Poids lourd</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('poidsLourd')" id="poidsLourdMinus">‚àí</button>
              <span class="counter-value" id="poidsLourd">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('poidsLourd')">+</button>
            </div>
          </div>
          <div id="poidsLourdDetails" class="vehicle-count-details hidden">
            <input type="text" placeholder="Nature du transport, code danger, code mati√®re" id="poidsLourdPrecisions">
          </div>
        </div>

        <!-- Deux roues -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Deux roues</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('deuxRoues')" id="deuxRouesMinus">‚àí</button>
              <span class="counter-value" id="deuxRoues">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('deuxRoues')">+</button>
            </div>
          </div>
          <div id="deuxRouesDetails" class="vehicle-count-details hidden">
            <input type="text" placeholder="Pr√©ciser nature, moto, scooter, trottinette.." id="deuxRouesPrecisions">
          </div>
        </div>

        <!-- Bus -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Bus</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('bus')" id="busMinus">‚àí</button>
              <span class="counter-value" id="bus">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('bus')">+</button>
            </div>
          </div>
          <div id="busDetails" class="vehicle-count-details hidden">
            <input type="text" placeholder="Pr√©ciser, bus scolaire, tourisme, nom soci√©t√©.." id="busPrecisions">
          </div>
        </div>

        <!-- Autre type de v√©hicule -->
        <a href="#" onclick="toggleAutreVehicule(); return false;" class="link-toggle" id="toggleAutreVehiculeBtn">
          Ajouter un autre type de v√©hicule
        </a>

        <div id="autreVehiculeDetails" class="sub-container hidden">
          <input type="text" placeholder="Pr√©ciser nature et nombre, train, tram, num√©ro de ligne.." id="autreVehicule">
        </div>

        <!-- D√©tails suppl√©mentaires -->
        <button type="button" class="toggle-btn" onclick="toggleDetailsSupplementaires()" id="toggleDetailsBtn">
          Ajouter d√©tails (fuite, feu..)
          <span class="toggle-icon">‚Ä∫</span>
        </button>

        <div id="detailsSupplementaires" class="sub-container hidden">
          <label>Pr√©sence d'une fuite en phase</label>
          <select id="typePhase">
            <option value="">Choisir</option>
            <option>Liquide</option>
            <option>Gazeuse</option>
            <option>Inflamm√©e</option>
          </select>

          <label>Localisation de la fuite</label>
          <input type="text" id="localisationFuite" placeholder="pr√©ciser localisation">

          <label>Pr√©sence d'un feu sur</label>
          <input type="text" id="presenceFeu" placeholder="Pr√©ciser quel v√©hicule">

          <label>Localisation du feu</label>
          <input type="text" id="localisationFeu" placeholder="Pr√©ciser localisation du feu">

          <label>Circonstances particuli√®res</label>
          <input type="text" id="circonstances" placeholder="Choisir (feu, ravin, eau, mati√®re dangereuse)">
        </div>
      </div>

      <!-- √âtat de la circulation -->
      <div id="etatCirculationContainer" class="sub-container hidden">
        <label>√âtat de la circulation sur la voie</label>
        <select id="etatCirculation" onchange="handleEtatCirculation(this.value)">
            <option value="Non alt√©r√©e" selected>Non alt√©r√©e</option>
            <option>Coup√©e</option>
            <option>Altern√©e</option>
            <option>Ralentie</option>
          </select>

        <div id="circulationDetails" class="hidden">
          <label>Nombre de voies impact√©es</label>
          <input type="text" placeholder="Pr√©ciser le nombre de voies impact√©es" id="voiesImpactees" onkeypress="return event.charCode >= 48 && event.charCode <= 57" pattern="[0-9]*">

          <label>Sens de circulation</label>
          <input type="text" placeholder="Pr√©ciser le sens de circulation" id="sensCirculation">
        </div>
      </div>

      <!-- Champs Feu de v√©hicule -->
      <div id="feuVehiculeFields" class="sub-container hidden">
        <label>Type de v√©hicule</label>
        <select id="typeVehicule">
          <option value="">Choisir</option>
          <optgroup label="V√©hicules terrestres">
            <option>V√©hicule l√©ger</option>
            <option>V√©hicule deux roues</option>
            <option>V√©hicule poids lourd</option>
            <option>V√©hicule poids lourd TMD</option>
            <option>V√©hicule agricole</option>
          </optgroup>
          <optgroup label="Autres v√©hicules">
            <option>Avion de ligne - militaire</option>
            <option>Avion de tourisme</option>
            <option>Bateau</option>
            <option>Bus</option>
            <option>H√©licopt√®re</option>
            <option>M√©tro</option>
            <option>P√©niche</option>
            <option>Tramway</option>
            <option>Train</option>
            <option>ULM</option>
          </optgroup>
        </select>

        <div id="codeMatiereTMDContainer" class="hidden">
          <label>Pr√©ciser code mati√®re</label>
          <input type="text" id="codeMatiereTMD" placeholder="Entrez le code mati√®re" onkeypress="return event.charCode >= 48 && event.charCode <= 57" pattern="[0-9]*">
          <div class="info-text">Rappel "X devant code mati√®re" = Pas d'eau</div>
        </div>

        <label>√ânergie</label>
        <select id="energieVehicule">
          <option value="">Choisir</option>
          <option>Essence</option>
          <option>Gazoil</option>
          <option>√âlectrique</option>
          <option>Hybride</option>
          <option>GPL</option>
          <option>Hydrog√®ne</option>
          <option>Inconnue</option>
        </select>

        <div class="risk-section vehicle-risk-section">
          <label>Risque de propagation</label>
          <div id="propagationVehiculeContainer">
            <button type="button" class="toggle-btn" onclick="selectToggle('propagationVehicule', this)" data-value="Oui">Oui</button>
            <button type="button" class="toggle-btn" onclick="selectToggle('propagationVehicule', this)" data-value="Non">Non</button>
          </div>
          <input type="hidden" id="propagationVehicule">
          <div id="propagationVehiculeDetails" class="hidden">
            <input type="text" placeholder="Pr√©ciser √† quoi peut se propager le feu" id="precisionsPropagationVehicule">
          </div>
        </div>

        <div class="risk-section vehicle-risk-section">
          <label>V√©hicule Isol√©</label>
          <div id="isoleVehiculeContainer">
            <button type="button" class="toggle-btn" onclick="selectToggle('isoleVehicule', this)" data-value="Oui">Oui</button>
            <button type="button" class="toggle-btn" onclick="selectToggle('isoleVehicule', this)" data-value="Non">Non</button>
          </div>
          <input type="hidden" id="isoleVehicule">
          <div id="isoleVehiculeDetails" class="hidden">
            <input type="text" placeholder="Pr√©ciser l'environnement" id="precisionsIsoleVehicule">
          </div>
        </div>

        <label>Pr√©sence d'un risque sp√©cifique</label>
        <select id="risqueSpecifiqueVehicule">
            <option value="">Choisir</option>
            <option>Hydrocarbure</option>
            <option>Ac√©tyl√®ne</option>
            <option>Engrais</option>
            <option>Gaz</option>
          </select>

        <label>√âvolution du feu</label>
        <select id="evolutionFeuVehicule">
            <option value="">Choisir</option>
          <option>1-En d√©veloppement</option>
          <option>2-Stabilis√©</option>
          <option>3-En r√©gression</option>
          <option>4-Circonscrit</option>
          <option>5-Ma√Ætris√©</option>
          <option>6-Foyer principal √©teint</option>
          <option>7-Feu √©teint</option>
          </select>
      </div>

      <!-- Champs communs b√¢timent -->
      <div id="batimentFields" class="sub-container hidden">
        <h3>Type de b√¢timent</h3>
        <div id="typeBatimentContainer">
          <button type="button" class="toggle-btn" onclick="selectBatimentType(this)" data-value="Plain pied">De plain pied</button>
          <button type="button" class="toggle-btn" onclick="selectBatimentType(this)" data-value="R+">B√¢timent R+</button>
        </div>

        <div id="etagesFields" class="hidden">
          <label>Nombre d'√©tages R+</label>
            <select id="etagesRPlus">
              <option value="">Choisir</option>
              <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
              <option>10</option><option>11</option><option>12</option>
            </select>

          <label>Nombre d'√©tages R-</label>
            <select id="etagesRMoins">
              <option value="">Choisir</option>
              <option>-1</option><option>-2</option><option>-3</option><option>-4</option><option>-5</option>
              <option>-6</option><option>-7</option><option>-8</option><option>-9</option><option>-10</option>
              <option>-11</option><option>-12</option>
            </select>
          </div>

        <label>Type de b√¢timent</label>
        <select id="typeBatimentSelect">
          <option value="">Choisir</option>
          <option>Appartement</option>
          <option>Maison</option>
          <option>Entrep√¥t</option>
          <option>Agricole</option>
          <option>Tertiaire</option>
          <option>ERP</option>
        </select>

        <label>B√¢timent √† usage de</label>
        <select id="usageBatiment">
          <option value="">Choisir</option>
          <option>Habitation (maison, villa, appartement)</option>
          <option>Usage commercial (magasin, centre commercial)</option>
          <option>Usage tertiaire (bureaux)</option>
          <option>Usage industriel (usine, entrep√¥t, site seveso)</option>
          <option>ERP (√©cole, h√¥pital, clinique, h√¥tel, EPHAD, Complexe sportif, salle de spectacle)</option>
          <option>Agricole</option>
        </select>

        <label>Structure</label>
          <select id="structure">
            <option value="">Choisir</option>
          <option>M√©tallique</option>
          <option>Traditionnelle</option>
          <option>B√©ton</option>
          <option>Bois</option>
          <option>Mixte</option>
          </select>

        <label>Surface totale estim√©e m¬≤</label>
        <input type="number" id="surfaceTotale" placeholder="Surface totale estim√©e en m¬≤">

        <label>Surface sinistr√©e estim√©e m¬≤</label>
        <input type="number" id="surfaceSinistree" placeholder="Surface sinistr√©e estim√©e en m¬≤">

        <div class="risk-section">
          <h4>Risque de propagation</h4>
          <div id="propagationBatimentContainer">
            <button type="button" class="toggle-btn" onclick="selectToggle('propagationBatiment', this)" data-value="Oui">Oui</button>
            <button type="button" class="toggle-btn" onclick="selectToggle('propagationBatiment', this)" data-value="Non">Non</button>
          </div>
          <input type="hidden" id="propagationBatiment">
          <div id="propagationBatimentDetails" class="hidden">
            <input type="text" placeholder="Pr√©ciser √† quoi peut se propager le feu" id="precisionsPropagationBatiment">
          </div>
        </div>

        <div class="risk-section">
          <h4>Isol√©</h4>
          <div id="isoleBatimentContainer">
            <button type="button" class="toggle-btn" onclick="selectToggle('isoleBatiment', this)" data-value="Oui">Oui</button>
            <button type="button" class="toggle-btn" onclick="selectToggle('isoleBatiment', this)" data-value="Non">Non</button>
          </div>
          <input type="hidden" id="isoleBatiment">
          <div id="isoleBatimentDetails" class="hidden">
            <input type="text" placeholder="Pr√©ciser l'environnement" id="precisionsIsoleBatiment">
          </div>
        </div>

        <label>Pr√©sence d'un risque sp√©cifique</label>
        <select id="risqueSpecifiqueBatiment">
            <option value="">Choisir</option>
          <option>Hydrocarbure</option>
          <option>Ac√©tyl√®ne</option>
          <option>Engrais</option>
          <option>Gaz</option>
          </select>

        <label>√âvolution du feu</label>
        <select id="evolutionFeuBatiment">
          <option value="">Choisir</option>
          <option>1-En d√©veloppement</option>
          <option>2-Stabilis√©</option>
          <option>3-En r√©gression</option>
          <option>4-Circonscrit</option>
          <option>5-Ma√Ætris√©</option>
          <option>6-Foyer principal √©teint</option>
          <option>7-Feu √©teint</option>
        </select>
        </div>

      <!-- Champs Chute de ligne √©lectrique -->
      <div id="chuteLigneFields" class="sub-container hidden">
        <label>Localisation de la chute</label>
        <input type="text" id="localisationChute" placeholder="Localisation de la chute">

        <h4>Type de ligne</h4>
        <div id="typeLigneContainer">
          <button type="button" class="toggle-btn" onclick="selectTypeLigne('BT')">BT</button>
          <button type="button" class="toggle-btn" onclick="selectTypeLigne('HTA')">HTA</button>
          <button type="button" class="toggle-btn" onclick="selectTypeLigne('HTB')">HTB</button>
      </div>
        <div id="perimetresInfo" class="info-text"></div>

        <button type="button" class="toggle-btn" onclick="toggleLigneDetails()" id="toggleLigneDetailsBtn">
          Ajouter d√©tails
          <span class="toggle-icon">‚Ä∫</span>
        </button>

        <div id="ligneDetailsFields" class="sub-container hidden">
          <label>Pr√©sence d'un feu sur</label>
          <input type="text" id="presenceFeuLigne" placeholder="Pr√©ciser quel v√©hicule">

          <label>Localisation du feu</label>
          <input type="text" id="localisationFeuLigne" placeholder="Pr√©ciser localisation du feu">

          <label>Circonstances particuli√®res</label>
          <input type="text" id="circonstancesLigne" placeholder="Choisir (feu, ravin, eau, mati√®re dangereuse)">
        </div>
      </div>

      <!-- Message d'information pour les fuites de gaz -->
      <div id="infoFuiteGaz" class="info-text hidden">
        Demande de PGR possible √† la demande du COS si :
        - fuite sur voie publique avec √©chappement √† l'air libre (fuite ouverte)
        - fuite √† l'int√©rieur d'un b√¢timent.
        Rappel des p√©rim√®tres : zone exclusion = 50m, zone contr√¥l√©e = 100m.
      </div>

      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(1)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="goToStep(3)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âtape 3 : Victimes -->
    <div id="step3" class="step hidden">
      <div id="victimsFields">
        <!-- UA -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Victime UA</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('UA')" id="UAMinus">‚àí</button>
              <span class="counter-value" id="UA">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('UA')">+</button>
            </div>
          </div>
        </div>

        <!-- UR -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Victime UR</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('UR')" id="URMinus">‚àí</button>
              <span class="counter-value" id="UR">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('UR')">+</button>
            </div>
          </div>
        </div>

        <!-- DCD -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Victime DCD</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('DCD')" id="DCDMinus">‚àí</button>
              <span class="counter-value" id="DCD">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('DCD')">+</button>
            </div>
          </div>
        </div>

        <!-- Incarc√©r√©es -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Victime Incarc√©r√©e</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('incarcerees')" id="incarcereesMinus">‚àí</button>
              <span class="counter-value" id="incarcerees">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('incarcerees')">+</button>
            </div>
          </div>
        </div>

        <!-- Intoxiqu√©es -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Victime Intoxiqu√©e</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('intoxiquees')" id="intoxiqueesMinus">‚àí</button>
              <span class="counter-value" id="intoxiquees">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('intoxiquees')">+</button>
            </div>
          </div>
        </div>

        <!-- Indemnes -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Indemne</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('indemnes')" id="indemnesMinus">‚àí</button>
              <span class="counter-value" id="indemnes">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('indemnes')">+</button>
            </div>
          </div>
        </div>

        <!-- Impliqu√©s -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Impliqu√©</label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('impliques')" id="impliquesMinus">‚àí</button>
              <span class="counter-value" id="impliques">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('impliques')">+</button>
            </div>
          </div>
        </div>

        <a href="#" onclick="togglePrecisionVictimes(); return false;" class="link-toggle" id="togglePrecisionVictimesBtn">
          Autres pr√©cisions sur victimes
          <span class="toggle-icon">‚Ä∫</span>
        </a>

        <div id="precisionVictimesContainer" class="sub-container hidden">
          <textarea id="precisionVictimes" placeholder="Saisissez des pr√©cisions suppl√©mentaires sur les victimes" style="width: 100%; min-height: 60px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
        </div>
      </div>
      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(2)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="goToStep(4)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âtape 4 : Je fais -->
    <div id="step4" class="step hidden">
      <!-- Nouvelle section "Je pr√©vois" -->
      <button type="button" class="toggle-btn" onclick="togglePrevois()" id="togglePrevoisBtn">
        Je pr√©vois (Chef de groupe)
        <span class="toggle-icon">‚Ä∫</span>
      </button>

      <div id="prevoisFields" class="sub-container hidden">
        <div id="prevoisActions">
          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="augmentationVictimes">Augmentation du nombre de victimes</button>
          <div id="augmentationVictimes" class="action-details hidden">
            <input type="text" id="preciserAugmentationVictimes" placeholder="Pr√©ciser l'augmentation du nombre de victimes">
          </div>

          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="aggravationVictimes">Aggravation de l'√©tat des victimes</button>
          <div id="aggravationVictimes" class="action-details hidden">
            <input type="text" id="preciserAggravationVictimes" placeholder="Pr√©ciser l'aggravation de l'√©tat des victimes">
          </div>

          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="interventionLongue">Intervention de longue dur√©e</button>
          <div id="interventionLongue" class="action-details hidden">
            <input type="text" id="preciserInterventionLongue" placeholder="Pr√©ciser l'intervention de longue dur√©e">
          </div>

          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="pollution">Pollution</button>
          <div id="pollution" class="action-details hidden">
            <input type="text" id="preciserPollution" placeholder="Pr√©ciser la pollution">
          </div>

          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="feu">Feu</button>
          <div id="feu" class="action-details hidden">
            <input type="text" id="preciserFeu" placeholder="Pr√©ciser le feu">
          </div>

          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="effondrement">Effondrement</button>
          <div id="effondrement" class="action-details hidden">
            <input type="text" id="preciserEffondrement" placeholder="Pr√©ciser l'effondrement">
          </div>

          <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="explosion">Explosion</button>
          <div id="explosion" class="action-details hidden">
            <input type="text" id="preciserExplosion" placeholder="Pr√©ciser l'explosion">
          </div>
        </div>
        <div class="field-group">
          <label for="precisionsPrevois">Pr√©ciser</label>
          <textarea id="precisionsPrevois" placeholder="Pr√©cisions sur les pr√©visions"></textarea>
        </div>
      </div>

      <h3>Victimes</h3>
      <hr>
      <div id="actionsContainer">
        <!-- Sauvetage des victimes -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="sauvetage">Sauvetage des victimes</button>
        <div id="sauvetage" class="action-details hidden">
          <input type="text" id="preciserSauvetage" placeholder="Pr√©ciser le sauvetage">
        </div>

        <!-- Prise en charge des victimes -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="priseEnCharge">Prise en charge des victimes</button>
        <div id="priseEnCharge" class="action-details hidden">
          <input type="text" id="preciserPriseEnCharge" placeholder="Pr√©ciser la prise en charge">
          <input type="number" id="nombreVictimesPriseEnCharge" placeholder="Nombre de victimes">
          <input type="text" id="parEquipage" placeholder="Par √©quipage (VSAV...)">
        </div>

        <!-- Mise en s√©curit√© des victimes -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="miseEnSecurite">Mise en s√©curit√© des victimes</button>
        <div id="miseEnSecurite" class="action-details hidden">
          <input type="text" id="preciserMiseEnSecurite" placeholder="Pr√©ciser la mise en s√©curit√©">
          <input type="number" id="nombrePersonnesMiseEnSecurite" placeholder="Nombre de personnes">
          <input type="text" id="pointRassemblement" placeholder="Point de rassemblement des victimes">
        </div>
      </div>

      <h3>Secours routier</h3>
      <hr>
      <div id="secoursRoutierContainer">
        <!-- D√©sincarc√©ration -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="desincarceration">D√©sincarc√©ration</button>
        <div id="desincarceration" class="action-details hidden">
          <input type="text" id="preciserDesincarceration" placeholder="Pr√©cisez la d√©sincarc√©ration">
        </div>

        <!-- Balisage -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="balisage">Balisage</button>
        <div id="balisage" class="action-details hidden">
          <input type="text" id="preciserBalisage" placeholder="Pr√©ciser balisage">
        </div>

        <!-- Arr√™t √©coulement -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="arretEcoulement">Arr√™t √©coulement / d√©versement</button>
        <div id="arretEcoulement" class="action-details hidden">
          <input type="text" id="preciserArretEcoulement" placeholder="Pr√©ciser l'arr√™t d'√©coulement">
        </div>
      </div>

      <h3>Incendie</h3>
      <hr>
      <div id="incendieContainer">
        <!-- Extinction -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="extinction">Extinction</button>
        <div id="extinction" class="action-details hidden">
          <input type="text" id="preciserExtinction" placeholder="Pr√©cisez l'extinction">
          <label for="nombreLDV">Nombre de LDV</label>
          <select id="nombreLDV">
            <option value="">Choisir</option>
            <option>1</option><option>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
          </select>
          <label for="debit">D√©bit</label>
          <select id="debit">
            <option value="">Choisir</option>
            <option>150L/min</option><option>250L/min</option>
            <option>500L/min</option><option>1000L/min</option>
          </select>
          <label for="fourgonAlimente">Fourgon aliment√©</label>
          <select id="fourgonAlimente">
            <option value="">Choisir</option>
            <option>Oui</option><option>Non</option>
            <option>Oui sur PI</option><option>Oui sur RI</option>
            <option>Oui sur Porteur d'eau</option>
          </select>
        </div>

        <!-- Coupures des √©nergies -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="coupuresEnergies">Coupures des √©nergies</button>
        <div id="coupuresEnergies" class="action-details hidden">
          <input type="text" id="preciserCoupuresEnergies" placeholder="Pr√©ciser les coupures d'√©nergies">
        </div>

        <!-- Relev√©s thermiques -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="relevesThermiques">Relev√©s thermiques</button>
        <div id="relevesThermiques" class="action-details hidden">
          <input type="text" id="preciserRelevesThermiques" placeholder="Pr√©ciser les relev√©s thermiques">
        </div>

        <!-- Relev√©s explosim√®tre -->
        <button type="button" class="toggle-btn" onclick="toggleActionDetails(this)" data-target="relevesExplosimetre">Relev√©s explosim√®tre</button>
        <div id="relevesExplosimetre" class="action-details hidden">
          <input type="text" id="preciserRelevesExplosimetre" placeholder="Pr√©ciser les relev√©s explosim√®tre">
        </div>

        <!-- D√©senfumage -->
        <button type="button" class="toggle-btn" onclick="toggleButton(this)">D√©senfumage</button>

        <!-- Ventilation -->
        <button type="button" class="toggle-btn" onclick="toggleButton(this)">Ventilation</button>

        <!-- D√©blai -->
        <button type="button" class="toggle-btn" onclick="toggleButton(this)">D√©blai</button>

        <!-- Je poursuis reconnaissance -->
        <button type="button" class="toggle-btn" onclick="toggleButton(this)">Je poursuis reconnaissance</button>
      </div>

      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(3)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="goToStep(5)">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âtape 5 : Je demande / confirme -->
    <div id="step5" class="step hidden">
      <h3>Moyens pompiers</h3>
      <hr>
      <div id="moyensPompiers">
        <!-- VSAV -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>VSAV <span class="suggestion-tag hidden" id="VSAVSuggestion"></span></label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('VSAV')" id="VSAVMinus">‚àí</button>
              <span class="counter-value" id="VSAV">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('VSAV')">+</button>
            </div>
          </div>
        </div>

        <!-- FPT -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>FPT <span class="suggestion-tag hidden" id="FPTSuggestion"></span></label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('FPT')" id="FPTMinus">‚àí</button>
              <span class="counter-value" id="FPT">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('FPT')">+</button>
            </div>
          </div>
        </div>

        <!-- EPA -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>EPA <span class="suggestion-tag hidden" id="EPASuggestion"></span></label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('EPA')" id="EPAMinus">‚àí</button>
              <span class="counter-value" id="EPA">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('EPA')">+</button>
            </div>
          </div>
        </div>

        <!-- Chef de groupe -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>Chef de groupe <span class="suggestion-tag hidden" id="chefGroupeSuggestion"></span></label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('chefGroupe')" id="chefGroupeMinus">‚àí</button>
              <span class="counter-value" id="chefGroupe">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('chefGroupe')">+</button>
            </div>
          </div>
        </div>

        <!-- V√©hicule sp√©cifique -->
        <div class="vehicle-count">
          <div class="vehicle-count-header">
            <label>V√©hicule sp√©cifique <span class="suggestion-tag hidden" id="vehiculeSpecifiqueSuggestion"></span></label>
            <div class="counter-container">
              <button type="button" class="counter-btn minus" onclick="decrementVehicle('vehiculeSpecifique')" id="vehiculeSpecifiqueMinus">‚àí</button>
              <span class="counter-value" id="vehiculeSpecifique">0</span>
              <button type="button" class="counter-btn plus" onclick="incrementVehicle('vehiculeSpecifique')">+</button>
            </div>
          </div>
          <div id="vehiculeSpecifiqueDetails" class="vehicle-count-details hidden">
            <input type="text" placeholder="Pr√©ciser le v√©hicule sp√©cifique" id="vehiculeSpecifiqueText">
          </div>
        </div>
      </div>

      <h3>Autres services</h3>
      <hr>
      <div id="autresServices">
        <button type="button" class="toggle-btn" id="action-ENEDIS" onclick="toggleButton(this)">ENEDIS</button>
        <button type="button" class="toggle-btn" id="action-GRDF" onclick="toggleButton(this)">GRDF</button>
        <button type="button" class="toggle-btn" id="action-SMUR" onclick="toggleButton(this)">SMUR <span class="suggestion-tag hidden" id="SMURSuggestion"></span></button>
        <button type="button" class="toggle-btn" id="action-gendarmerie" onclick="toggleButton(this)">Gendarmerie <span class="suggestion-tag hidden" id="gendarmerieSuggestion"></span></button>
        <button type="button" class="toggle-btn" id="action-police" onclick="toggleButton(this)">Police <span class="suggestion-tag hidden" id="policeSuggestion"></span></button>
        <button type="button" class="toggle-btn" id="action-elus" onclick="toggleButton(this)">√âlus</button>
        <button type="button" class="toggle-btn" id="action-RTE" onclick="toggleButton(this)" style="display:none;">RTE</button>
      </div>

      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(4)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="generateMessage()">Suivant ‚Üí</button>
      </div>
    </div>

    <!-- √âtape 6 : Message g√©n√©r√© -->
    <div id="step6" class="step hidden">
      <textarea id="message" class="result" readonly contenteditable="true"></textarea>
      <textarea id="additionalInfo" placeholder="Ajouter une information suppl√©mentaire manuellement" style="width: 100%; margin-top: 10px; padding: 10px; min-height: 60px;"></textarea>
      <div class="navigation-buttons">
        <button type="button" class="prev-btn" onclick="goToStep(5)">‚Üê Pr√©c√©dent</button>
        <hr>
        <button type="button" onclick="copyMessage()">Copier le message</button>
        <button type="button" onclick="sendMail()">Envoyer par mail</button>
        <button type="button" class="reset-btn" onclick="resetForm()">Recommencer le message</button>
      </div>
    </div>
  </div>
  <div class="update-container">
    <p class="offline-info"><i>L'application fonctionne m√™me hors ligne.</i></p>
    <a href="#" id="updateLink" class="update-link" onclick="checkForUpdates(); return false;">V√©rifier si l'app est √† jour</a>
    <p id="updateStatus" class="update-status"></p>
    <div class="app-info">
      <img src="icons/192.png" alt="MRP Icon" class="app-icon">
      <p class="app-name">MRP</p>
      <p class="version-info">Version : 1.0.11</p>
    </div>
    <p class="copyright">¬© Tael PINAULT 2025</p>
  </div>

  <script>
    let currentStep = 0,
        selectedNature = "",
        selectedBatiment = "",
        victimsSelected = false;

    function goToStep(step) {
      document.querySelector(`.step.active`).classList.replace("active", "hidden");
      document.querySelector(`#step${step}`).classList.replace("hidden", "active");
      
      // Mettre √† jour la classe active des √©l√©ments de progression
      document.querySelectorAll('.progress-step').forEach((el, index) => {
        if (index === step) {
          el.classList.add('active');
        } else {
          el.classList.remove('active');
        }
      });
      
      currentStep = step;
      updateProgress();
      
      // Faire d√©filer vers le haut de la page
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      
      // Si on arrive √† l'√©tape "Je suis" (step 1), v√©rifier si le motif est AVP
      if (step === 1) {
        const motifDepart = document.getElementById('motifDepart').value;
        if (motifDepart === 'AVP') {
          updateRouteFields();
        }
      }
      
      // Si on arrive √† l'√©tape "Je vois" (step 2), s√©lectionner automatiquement le motif de d√©part
      if (step === 2) {
        const motifDepart = document.getElementById('motifDepart').value;
        
        // R√©initialiser d'abord toutes les s√©lections
        document.querySelectorAll(".nature-toggle").forEach(b => b.classList.remove("selected"));
        
        // S√©lectionner le bouton appropri√© en fonction du motif de d√©part
        switch(motifDepart) {
          case 'AVP':
            const avpButton = document.querySelector('.nature-toggle[data-value="AVP"]');
            if (avpButton) {
              selectNature(avpButton);
              // Forcer l'affichage des champs AVP et de l'√©tat de la circulation
              document.getElementById("avpFields").classList.remove("hidden");
              document.getElementById("etatCirculationContainer").classList.remove("hidden");
            }
            break;
          case 'Feu de v√©hicule':
            const feuVLButton = document.querySelector('.nature-toggle[data-value="Feu de v√©hicule"]');
            if (feuVLButton) selectNature(feuVLButton);
            break;
          case 'Feu de b√¢timent':
            const feuBatButton = document.querySelector('.nature-toggle[data-value="Feu de b√¢timent"]');
            if (feuBatButton) selectNature(feuBatButton);
            break;
          case 'Chute de ligne √©lectrique':
          case 'Odeur de brul√©':
          case 'Fum√©e suspecte':
          case 'Fuite de Gaz proc√©dure classique':
          case 'Fuite de Gaz proc√©dure renforc√©e':
          case 'D√©clenchement alarme':
          case 'Autre type d\'intervention':
            const autreButton = document.querySelector('.nature-toggle[data-value="Autre"]');
            if (autreButton) {
              selectNature(autreButton);
              const autreSelect = document.getElementById('autreTypeIntervention');
              if (autreSelect) {
                autreSelect.value = motifDepart;
                handleAutreIntervention(motifDepart);
              }
            }
            break;
        }
      }

      // Si on arrive √† l'√©tape des victimes (step 3), activer automatiquement la section
      if (step === 3) {
        victimsSelected = true;
      }
      
      if (step === 5) updateSuggestions();
    }

    function updateProgress() {
      document.querySelectorAll(".progress-step").forEach((el, index) => {
        el.classList.toggle("active", index === currentStep);
      });
    }

    function setCurrentTime() {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      document.getElementById('groupeHoraireAuto').value = `${hours}:${minutes}`;
      updateMessage();
    }

    function geolocalise() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          let lat = pos.coords.latitude, lon = pos.coords.longitude;
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
            .then(r => r.json()).then(d => {
              console.log('Donn√©es re√ßues:', d);
              
              let address = '';
              if (d.address) {
                console.log('Composants d\'adresse:', d.address);
                
                // Construire l'adresse dans l'ordre logique
                if (d.address.isolated_dwelling) {
                  address = d.address.isolated_dwelling;
                }
                
                if (d.address.neighbourhood) {
                  if (address) address += ', ';
                  address += d.address.neighbourhood;
                }
                
                if (d.address.road) {
                  if (address) address += ', ';
                  address += d.address.road;
                }
                
                // Si nous n'avons toujours pas d'adresse, utiliser le village
                if (!address && d.address.village) {
                  address = d.address.village;
                }
                
                console.log('Adresse construite:', address);
                
                // Si aucune adresse n'a pu √™tre construite, utiliser l'adresse compl√®te
                if (!address) {
                  address = d.display_name || `Lat:${lat},Lon:${lon}`;
                }
                
                document.querySelector("#adresse").value = address;
                
                // Mettre √† jour la commune si elle est disponible
                if (d.address) {
                  const commune = d.address.village || d.address.town || d.address.city || d.address.municipality || "";
                  if (commune) {
                    document.querySelector("#commune").value = commune;
                  }
                }
                
                // Afficher les informations GPS
                document.getElementById("gpsInfo").classList.remove("hidden");
                document.getElementById("gpsInfoCommune").classList.remove("hidden");
              }
            })
            .catch(error => {
              console.error('Erreur lors de la g√©olocalisation:', error);
              document.querySelector("#adresse").value = `Lat:${lat},Lon:${lon}`;
              // Afficher les informations GPS m√™me en cas d'erreur de g√©ocodage
              document.getElementById("gpsInfo").classList.remove("hidden");
              document.getElementById("gpsInfoCommune").classList.remove("hidden");
            });
        });
      }
    }

    // Ajout d'une fonction pour r√©initialiser les infos GPS quand l'utilisateur modifie manuellement les champs
    function setupGPSInfoReset() {
      ['adresse', 'commune'].forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
          document.getElementById("gpsInfo").classList.add("hidden");
          document.getElementById("gpsInfoCommune").classList.add("hidden");
        });
      });
    }

    function increment(id) {
      let i = document.getElementById(id);
      i.value = +i.value + 1;
    }

    function decrement(id) {
      let i = document.getElementById(id);
      if (+i.value > 0) i.value = +i.value - 1;
    }

    function selectNature(btn) {
      // Si le bouton est d√©j√† s√©lectionn√©, on le d√©s√©lectionne et on cache tous les champs
      if (btn.classList.contains("selected")) {
        btn.classList.remove("selected");
        selectedNature = "";
        ["avpFields", "feuVehiculeFields", "batimentFields", "chuteLigneFields", "autreTypeBox", "etatCirculationContainer"].forEach(id => 
          document.getElementById(id).classList.add("hidden")
        );
        document.getElementById("infoFuiteGaz").classList.add("hidden");
        // Suppression de la ligne suivante
        // document.getElementById("selectedNatureTitle").classList.add("hidden");
        // R√©initialiser les champs du formulaire
        resetFields();
        updateSuggestions(); // Mettre √† jour les suggestions quand on d√©s√©lectionne
        return;
      }

      // R√©initialiser le select d'autres types d'intervention
      document.getElementById("autreTypeIntervention").value = "";

      document.querySelectorAll(".nature-toggle").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedNature = btn.dataset.value;
      
      // Hide all fields first
      ["avpFields", "feuVehiculeFields", "batimentFields", "chuteLigneFields", "autreTypeBox", "etatCirculationContainer"].forEach(id => 
        document.getElementById(id).classList.add("hidden")
      );
      document.getElementById("infoFuiteGaz").classList.add("hidden");
      // Suppression de la ligne suivante
      // document.getElementById("selectedNatureTitle").classList.add("hidden");

      // Show relevant fields based on selection
      if (selectedNature === "AVP") {
        document.getElementById("avpFields").classList.remove("hidden");
        document.getElementById("etatCirculationContainer").classList.remove("hidden");
        updateSuggestions(); // Mettre √† jour les suggestions quand AVP est s√©lectionn√©
      } else if (selectedNature === "Feu de v√©hicule") {
        document.getElementById("feuVehiculeFields").classList.remove("hidden");
      } else if (selectedNature === "Feu de b√¢timent") {
        document.getElementById("batimentFields").classList.remove("hidden");
      } else if (selectedNature === "Autre") {
        document.getElementById("autreTypeBox").classList.remove("hidden");
        // Suppression de la ligne suivante
        // document.getElementById("selectedNatureTitle").classList.remove("hidden");
      }
    }

    function handleAutreIntervention(value) {
      if (!value) {
        resetFields();
        document.getElementById("selectedNatureTitle").classList.add("hidden");
        return;
      }

      // D√©s√©lectionner tous les boutons de nature sauf "Autre"
      document.querySelectorAll(".nature-toggle").forEach(b => {
        if (b.dataset.value !== "Autre") {
          b.classList.remove("selected");
        }
      });
      selectedNature = value;
      
      // Hide all fields first
      ["avpFields", "feuVehiculeFields", "batimentFields", "chuteLigneFields"].forEach(id => 
        document.getElementById(id).classList.add("hidden")
      );
      document.getElementById("infoFuiteGaz").classList.add("hidden");
      document.getElementById("selectedNatureTitle").classList.add("hidden");

      // Show relevant fields based on selection
      if (value === "Chute de ligne √©lectrique") {
        document.getElementById("chuteLigneFields").classList.remove("hidden");
      } else if (value.startsWith("Fuite de gaz")) {
        document.getElementById("batimentFields").classList.remove("hidden");
        document.getElementById("infoFuiteGaz").classList.remove("hidden");
      } else if (["Fum√©e suspecte", "Odeur de brul√©", "Autre type de feu"].includes(value)) {
        document.getElementById("batimentFields").classList.remove("hidden");
      }
    }

    function updateMinusButtonState(id) {
      let minusBtn = document.getElementById(id + "Minus");
      let value = parseInt(document.getElementById(id).textContent);
      if (value === 0) {
        minusBtn.classList.add("disabled");
        minusBtn.disabled = true;
      } else {
        minusBtn.classList.remove("disabled");
        minusBtn.disabled = false;
      }
    }

    // Initialiser l'√©tat des boutons au chargement
    window.addEventListener('load', function() {
      // Compteurs de v√©hicules
      ['vehiculeLeger', 'poidsLourd', 'deuxRoues', 'bus'].forEach(id => {
        updateMinusButtonState(id);
        updateVehicleDetails(id);
      });
      
      // Compteurs de victimes
      ['victimes', 'indemnes', 'UA', 'UR', 'DCD', 'incarcerees', 'intoxiquees', 'impliques'].forEach(id => {
        updateMinusButtonState(id);
      });
      
      // Compteurs de moyens pompiers
      ['VSAV', 'FPT', 'EPA', 'chefGroupe', 'vehiculeSpecifique'].forEach(id => {
        updateMinusButtonState(id);
      });
    });

    function incrementVehicle(id) {
      let span = document.getElementById(id);
      let value = parseInt(span.textContent) + 1;
      span.textContent = value;
      updateVehicleDetails(id);
      updateMinusButtonState(id);
    }

    function decrementVehicle(id) {
      let span = document.getElementById(id);
      let value = parseInt(span.textContent);
      if (value > 0) {
        value--;
        span.textContent = value;
        updateVehicleDetails(id);
        updateMinusButtonState(id);
      }
    }

    function updateVehicleDetails(id) {
      let details = document.getElementById(id + "Details");
      let value = parseInt(document.getElementById(id).textContent);
      if (details) {
        if (value > 0) {
          details.classList.remove("hidden");
        } else {
          details.classList.add("hidden");
        }
      }
    }

    function toggleDetailsSupplementaires() {
      const details = document.getElementById("detailsSupplementaires");
      const btn = document.getElementById("toggleDetailsBtn");
      const icon = btn.querySelector('.toggle-icon');
      
      details.classList.toggle("hidden");
      btn.classList.toggle("active");
      icon.classList.toggle("rotated");
    }

    function selectTypeLigne(type) {
      document.querySelectorAll("#typeLigneContainer .toggle-btn").forEach(btn => 
        btn.classList.remove("selected")
      );
      document.querySelector(`#typeLigneContainer button[onclick="selectTypeLigne('${type}')"]`).classList.add("selected");
      
      let info = document.getElementById("perimetresInfo");
      if (type === "BT") {
        info.innerText = "Rappel des p√©rim√®tres : zone exclusion = 1m, zone contr√¥l√©e = 20m.";
      } else {
        info.innerText = "Rappel des p√©rim√®tres : zone exclusion = 10m, zone contr√¥l√©e = 50m.";
      }
      info.classList.remove("hidden");

      // Show/hide RTE button in "Je demande" step
      let rteBtn = document.getElementById("action-RTE");
      if (rteBtn) {
        rteBtn.style.display = type === "HTB" ? "block" : "none";
        if (type !== "HTB") rteBtn.classList.remove("selected");
      }
    }

    function selectToggle(field, button) {
      const container = document.getElementById(`${field}Container`);
      const buttons = container.querySelectorAll('.toggle-btn');
      const detailsContainer = document.getElementById(`${field}Details`);
      
      buttons.forEach(btn => {
        if (btn === button) {
          btn.classList.add('selected');
          document.getElementById(field).value = button.getAttribute('data-value');
          // G√©rer l'affichage des d√©tails en fonction du type de section
          if (detailsContainer) {
            if (field === 'isoleVehicule') {
              // Pour "V√©hicule Isol√©", afficher les d√©tails si "Non" est s√©lectionn√©
              if (button.getAttribute('data-value') === 'Non') {
                detailsContainer.classList.remove('hidden');
              } else {
                detailsContainer.classList.add('hidden');
              }
            } else if (field === 'propagationVehicule') {
              // Pour "Risque de propagation", afficher les d√©tails si "Oui" est s√©lectionn√©
              if (button.getAttribute('data-value') === 'Oui') {
                detailsContainer.classList.remove('hidden');
              } else {
                detailsContainer.classList.add('hidden');
              }
            }
          }
        } else {
          btn.classList.remove('selected');
        }
      });
    }

    function selectBatimentType(btn) {
      // Si le bouton est d√©j√† s√©lectionn√©, on le d√©s√©lectionne
      if (btn.classList.contains("selected")) {
        btn.classList.remove("selected");
        selectedBatiment = "";
        document.getElementById("etagesFields").classList.add("hidden");
        return;
      }

      // D√©s√©lectionner tous les boutons avant de s√©lectionner le nouveau
      document.querySelectorAll("#typeBatimentContainer .toggle-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedBatiment = btn.dataset.value;
      document.getElementById("etagesFields").classList.toggle("hidden", selectedBatiment !== "R+");

      // R√©initialiser les champs d'√©tages si on passe √† "Plain pied"
      if (selectedBatiment === "Plain pied") {
        document.getElementById("etagesRPlus").value = "";
        document.getElementById("etagesRMoins").value = "";
      }
    }

    function selectVictimsToggle(show, btn) {
      document.querySelectorAll("#victimsToggleContainer .toggle-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      victimsSelected = show;
      document.getElementById("victimsFields").classList.toggle("hidden", !show);
    }

    function toggleButton(el) {
      el.classList.toggle("selected");
      
      // Si le bouton a un data-target, g√©rer l'affichage des d√©tails
      const target = el.getAttribute("data-target");
      if (target) {
        const details = document.getElementById(target);
        if (details) {
          details.classList.toggle("hidden");
        }
      }
    }

    function updateExtinctionFields() {
      document.getElementById("extinctionFields").classList.toggle("hidden",
        !document.getElementById("action-extinction").classList.contains("selected"));
    }

    function updateCamThermiqueField() {
      document.getElementById("camThermiqueContainer").classList.toggle("hidden",
        !document.getElementById("action-relevesThermiques").classList.contains("selected"));
    }

    function updateExplosimetreField() {
      document.getElementById("explosimetreContainer").classList.toggle("hidden",
        !document.getElementById("action-relevesExplosimetre").classList.contains("selected"));
    }

    function updateSuggestions() {
      // R√©initialiser tous les tags de suggestion
      document.querySelectorAll('.suggestion-tag').forEach(tag => {
        tag.classList.add('hidden');
      });

      // V√©rifier les suggestions pour chaque moyen
      if (selectedBatiment === "R+") {
        document.getElementById("EPA").textContent = "1";
        document.getElementById("EPASuggestion").textContent = "sugg√©r√© 1";
        document.getElementById("EPASuggestion").classList.remove("hidden");
      }

      let ua = +document.getElementById("UA").textContent;
      let ur = +document.getElementById("UR").textContent;
      if (ua + ur > 0) {
        let cnt = Math.min(ua + ur, 5);
        document.getElementById("VSAV").textContent = cnt.toString();
        document.getElementById("VSAVSuggestion").textContent = `sugg√©r√© ${cnt}`;
        document.getElementById("VSAVSuggestion").classList.remove("hidden");
        
        if (ua > 0) {
          document.getElementById("SMURSuggestion").textContent = "sugg√©r√©";
          document.getElementById("SMURSuggestion").classList.remove("hidden");
        }
      }

      // Ajouter les suggestions pour Police et Gendarmerie si AVP est s√©lectionn√©
      if (selectedNature === "AVP") {
        document.getElementById("policeSuggestion").textContent = "sugg√©r√©";
        document.getElementById("gendarmerieSuggestion").textContent = "sugg√©r√©";
        document.getElementById("policeSuggestion").classList.remove("hidden");
        document.getElementById("gendarmerieSuggestion").classList.remove("hidden");
      }
    }

    function generateMessage() {
      let msg = "[ CODIS, PRENEZ MESSAGE ]\n";
      let getVal = id => document.getElementById(id)?.value || "";
      
      // Intervention info
      if (getVal("groupeHoraireAuto")) msg += `Groupe horaire: ${getVal("groupeHoraireAuto")}\n`;
      if (getVal("interventionNumber")) msg += `Intervention num√©ro: ${getVal("interventionNumber")}\n`;
      msg += "\n";

      // Location info
      msg += "[ JE SUIS ]\n";
      if (getVal("adresse")) msg += `Adresse: ${getVal("adresse")}\n`;
      if (getVal("adresseConfirmee")) msg += `Adresse confirm√©e/modifi√©e: ${getVal("adresseConfirmee")}\n`;
      if (getVal("commune")) msg += `Commune: ${getVal("commune")}\n`;
      if (getVal("typeRoute")) msg += `Type de route: ${getVal("typeRoute")}\n`;
      if (getVal("numeroRoute")) msg += `Num√©ro de route: ${getVal("numeroRoute")}\n`;
      if (getVal("nomEchangeur")) msg += `Nom de l'√©changeur: ${getVal("nomEchangeur")}\n`;
      if (getVal("pk")) msg += `PK: ${getVal("pk")}\n`;
      if (getVal("sens")) msg += `Sens: ${getVal("sens")}\n`;
      msg += "\n";

      // Situation info
      msg += "[ JE VOIS ]\n";
      
      // Get selected nature
      let natureBtn = document.querySelector(".nature-toggle.selected");
      let autreNature = getVal("autreTypeIntervention");
      let nature = natureBtn ? natureBtn.dataset.value : autreNature;
      
      if (nature) {
        msg += `Un ${nature}\n`;

        // AVP specific fields
        if (nature === "AVP") {
          msg += "Impliquant:\n";
          let vehicules = ["vehiculeLeger", "poidsLourd", "deuxRoues", "bus"];
          vehicules.forEach(v => {
            let count = document.getElementById(v)?.textContent || "0";
            if (count !== "0") {
              msg += `- ${count} ${v.replace(/([A-Z])/g, ' $1').toLowerCase()}\n`;
              let precisions = getVal(v + "Precisions");
              if (precisions) msg += `  Pr√©cisions: ${precisions}\n`;
            }
          });

          let autreVehicule = getVal("autreVehicule");
          if (autreVehicule) msg += `- Autre v√©hicule: ${autreVehicule}\n`;

          // D√©tails suppl√©mentaires
          if (!document.getElementById("detailsSupplementaires").classList.contains("hidden")) {
            msg += "\n";
            let typePhase = getVal("typePhase");
            if (typePhase) msg += `Fuite en phase: ${typePhase}\n`;
            if (getVal("localisationFuite")) msg += `Localisation fuite: ${getVal("localisationFuite")}\n`;
            if (getVal("presenceFeu")) msg += `Pr√©sence feu sur: ${getVal("presenceFeu")}\n`;
            if (getVal("localisationFeu")) msg += `Localisation feu: ${getVal("localisationFeu")}\n`;
            if (getVal("circonstances")) msg += `Circonstances particuli√®res: ${getVal("circonstances")}\n`;
          }

          // √âtat circulation
          msg += "\n";
          if (getVal("etatCirculation")) msg += `√âtat circulation: ${getVal("etatCirculation")}\n`;
          if (getVal("voiesImpactees")) msg += `Voies impact√©es: ${getVal("voiesImpactees")}\n`;
          if (getVal("sensCirculation")) msg += `Sens circulation: ${getVal("sensCirculation")}\n`;
        }

        // Feu de v√©hicule specific fields
        else if (nature === "Feu de v√©hicule") {
          if (getVal("typeVehicule")) msg += `Type de v√©hicule: ${getVal("typeVehicule")}\n`;
          if (getVal("energieVehicule")) msg += `√ânergie: ${getVal("energieVehicule")}\n`;
          
          let propagation = getVal("propagationVehicule");
          if (propagation) {
            msg += `Risque de propagation: ${propagation}\n`;
            if (propagation === "Oui" && getVal("precisionsPropagationVehicule")) {
              msg += `Pr√©cisions propagation: ${getVal("precisionsPropagationVehicule")}\n`;
            }
          }

          let isole = getVal("isoleVehicule");
          if (isole) {
            msg += `V√©hicule isol√©: ${isole}\n`;
            if (isole === "Oui" && getVal("precisionsIsoleVehicule")) {
              msg += `Pr√©cisions environnement: ${getVal("precisionsIsoleVehicule")}\n`;
            }
          }

          if (getVal("risqueSpecifiqueVehicule")) msg += `Risque sp√©cifique: ${getVal("risqueSpecifiqueVehicule")}\n`;
          if (getVal("evolutionFeuVehicule")) msg += `√âvolution du feu: ${getVal("evolutionFeuVehicule")}\n`;
          if (getVal("typeVehicule") === "V√©hicule poids lourd TMD" && getVal("codeMatiereTMD")) {
            msg += `Code mati√®re TMD: ${getVal("codeMatiereTMD")}\n`;
          }
        }

        // Building related fields (used by multiple types)
        else if (nature === "Feu de b√¢timent" || nature.includes("Fuite de gaz") || 
                 nature === "Fum√©e suspecte" || nature === "Odeur de brul√©" || 
                 nature === "Autre type de feu") {
          
          let batimentType = document.querySelector("#typeBatimentContainer .toggle-btn.selected");
          if (batimentType) {
            msg += "Type de b√¢timent:\n";
            let typeValue = batimentType.dataset.value;
            msg += typeValue === "R+" ? `B√¢timent : R+\n` : `B√¢timent de : Plain pied\n`;
            if (typeValue === "R+") {
              if (getVal("etagesRPlus")) msg += `Nombre d'√©tages R+: ${getVal("etagesRPlus")}\n`;
              if (getVal("etagesRMoins")) msg += `Nombre d'√©tages R-: ${getVal("etagesRMoins")}\n`;
            }
          }

          if (getVal("usageBatiment")) msg += `B√¢timent √† usage de: ${getVal("usageBatiment")}\n`;
          if (getVal("typeBatimentSelect")) msg += `De type: ${getVal("typeBatimentSelect")}\n`;
          if (getVal("structure")) msg += `Structure: ${getVal("structure")}\n`;
          if (getVal("surfaceTotale")) msg += `Surface totale: ${getVal("surfaceTotale")} m¬≤\n`;
          if (getVal("surfaceSinistree")) msg += `Surface sinistr√©e: ${getVal("surfaceSinistree")} m¬≤\n`;

          let propagation = getVal("propagationBatiment");
          if (propagation) {
            msg += `Risque de propagation: ${propagation}\n`;
            if (propagation === "Oui" && getVal("precisionsPropagationBatiment")) {
              msg += `Pr√©cisions propagation: ${getVal("precisionsPropagationBatiment")}\n`;
            }
          }

          let isole = getVal("isoleBatiment");
          if (isole) {
            msg += `B√¢timent isol√©: ${isole}\n`;
            if (isole === "Oui" && getVal("precisionsIsoleBatiment")) {
              msg += `Pr√©cisions environnement: ${getVal("precisionsIsoleBatiment")}\n`;
            }
          }

          if (getVal("risqueSpecifiqueBatiment")) msg += `Risque sp√©cifique: ${getVal("risqueSpecifiqueBatiment")}\n`;
          if (getVal("evolutionFeuBatiment")) msg += `√âvolution du feu: ${getVal("evolutionFeuBatiment")}\n`;
        }

        // Chute de ligne √©lectrique specific fields
        else if (nature === "Chute de ligne √©lectrique") {
          if (getVal("localisationChute")) msg += `Localisation de la chute: ${getVal("localisationChute")}\n`;
          let typeLigne = document.querySelector("#typeLigneContainer .toggle-btn.selected");
          if (typeLigne) {
            msg += `Type de ligne: ${typeLigne.textContent}\n`;
          }
          
          // Ajouter les d√©tails suppl√©mentaires s'ils sont pr√©sents
          if (!document.getElementById("ligneDetailsFields").classList.contains("hidden")) {
            msg += "\n";
            if (getVal("presenceFeuLigne")) msg += `Pr√©sence d'un feu sur: ${getVal("presenceFeuLigne")}\n`;
            if (getVal("localisationFeuLigne")) msg += `Localisation du feu: ${getVal("localisationFeuLigne")}\n`;
            if (getVal("circonstancesLigne")) msg += `Circonstances particuli√®res: ${getVal("circonstancesLigne")}\n`;
          }
        }
      }
      msg += "\n";

      // Victimes info
      msg += "[ VICTIMES ]\n";
      const victimTypes = {
        "UA": "Victime UA",
        "UR": "Victime UR",
        "DCD": "Victime DCD",
        "incarcerees": "Victime Incarc√©r√©e",
        "intoxiquees": "Victime Intoxiqu√©e",
        "indemnes": "Indemne",
        "impliques": "Impliqu√©"
      };

      let hasVictims = false;
      Object.entries(victimTypes).forEach(([id, label]) => {
        const count = parseInt(document.getElementById(id)?.textContent || "0");
        if (count > 0) {
          hasVictims = true;
          msg += `${count} ${label}\n`;
        }
      });

      // Ajouter les pr√©cisions sur les victimes si pr√©sentes
      let precisionVictimes = getVal("precisionVictimes");
      if (precisionVictimes) {
        msg += `Pr√©cisions sur les victimes: ${precisionVictimes}\n`;
      }
      
      if (hasVictims) {
        msg += "\n";
      }

      // Actions info
      msg += "[ JE FAIS ]\n";
      
      // R√©cup√©rer toutes les actions s√©lectionn√©es de tous les conteneurs
      const actionContainers = ['actionsContainer', 'incendieContainer', 'secoursRoutierContainer'];
      actionContainers.forEach(containerId => {
        document.querySelectorAll(`#${containerId} .toggle-btn.selected`).forEach(btn => {
          const action = btn.textContent;
          const target = btn.getAttribute('data-target');
          
          // Si l'action a des d√©tails
          if (target) {
            const details = document.getElementById(target);
            if (details) {
              msg += `${action}\n`;
              
              // Pour l'extinction, inclure tous les d√©tails sp√©cifiques
              if (target === 'extinction') {
                const precisions = getVal('preciserExtinction');
                if (precisions) msg += `Pr√©cisions: ${precisions}\n`;
                const nbLDV = getVal('nombreLDV');
                if (nbLDV) msg += `${nbLDV} LDV\n`;
                if (getVal('debit')) msg += `D√©bit: ${getVal('debit')}\n`;
                if (getVal('fourgonAlimente')) msg += `Fourgon aliment√©: ${getVal('fourgonAlimente')}\n`;
              }
              // Pour la mise en s√©curit√©
              else if (target === 'miseEnSecurite') {
                const precisions = getVal('preciserMiseEnSecurite');
                if (precisions) msg += `Pr√©cisions: ${precisions}\n`;
                const nbPersonnes = getVal('nombrePersonnesMiseEnSecurite');
                if (nbPersonnes) msg += `${nbPersonnes} personnes\n`;
                const pointRassemblement = getVal('pointRassemblement');
                if (pointRassemblement) msg += `Point de rassemblement: ${pointRassemblement}\n`;
              }
              // Pour la prise en charge des victimes
              else if (target === 'priseEnCharge') {
                const precisions = getVal('preciserPriseEnCharge');
                if (precisions) msg += `Pr√©cisions: ${precisions}\n`;
                const nbVictimes = getVal('nombreVictimesPriseEnCharge');
                if (nbVictimes) msg += `${nbVictimes} victimes\n`;
                const parEquipage = getVal('parEquipage');
                if (parEquipage) msg += `Par √©quipage: ${parEquipage}\n`;
              }
              // Pour les autres actions avec pr√©cisions
              else {
                const precisionInput = details.querySelector('input[type="text"]');
                if (precisionInput && precisionInput.value) {
                  msg += `Pr√©cisions: ${precisionInput.value}\n`;
                }
              }
            }
          } else {
            // Actions sans d√©tails (comme D√©senfumage, Ventilation, etc.)
            msg += `${action}\n`;
          }
        });
      });

      // Ajouter les pr√©visions du chef de groupe si pr√©sentes
      const prevoisBtn = document.getElementById('togglePrevoisBtn');
      if (prevoisBtn.classList.contains('active')) {
        msg += "\nJE PREVOIS:\n";
        document.querySelectorAll('#prevoisActions .toggle-btn.selected').forEach(btn => {
          const action = btn.textContent;
          const target = btn.getAttribute('data-target');
          if (target) {
            const details = document.getElementById(target);
            if (details) {
              msg += `${action}\n`;
              const precisionInput = details.querySelector('input[type="text"]');
              if (precisionInput && precisionInput.value) {
                msg += `Pr√©cisions: ${precisionInput.value}\n`;
              }
            }
          } else {
            msg += `${action}\n`;
          }
        });
      }

      // Ajouter les moyens demand√©s
      msg += "\n[ JE DEMANDE ]\n";
      const moyensTypes = {
        "VSAV": "VSAV",
        "FPT": "FPT",
        "EPA": "EPA",
        "chefGroupe": "Chef de groupe",
        "vehiculeSpecifique": "V√©hicule sp√©cifique"
      };

      Object.entries(moyensTypes).forEach(([id, label]) => {
        const count = parseInt(document.getElementById(id)?.textContent || "0");
        if (count > 0) {
          if (id === "vehiculeSpecifique") {
            const details = document.getElementById("vehiculeSpecifiqueText");
            if (details && details.value) {
              msg += `${count} ${details.value}\n`;
            } else {
              msg += `${count} ${label}\n`;
            }
          } else {
            msg += `${count} ${label}\n`;
          }
        }
      });

      // Ajouter les autres services demand√©s
      document.querySelectorAll('#autresServices .toggle-btn.selected').forEach(btn => {
        msg += `${btn.textContent}\n`;
      });

      msg += "\n[ FIN DE MESSAGE, COMMENT RE√áU PARLEZ. ]";
      
      // Mettre √† jour le textarea avec le message en texte brut
      const messageTextarea = document.getElementById("message");
      messageTextarea.value = msg;
      
      // Ajuster la hauteur du textarea
      setTimeout(() => {
        messageTextarea.style.height = "auto";
        messageTextarea.style.height = messageTextarea.scrollHeight + "px";
      }, 0);
      
      goToStep(6);
    }

    function copyMessage() {
      let msg = document.getElementById("message").value;
      // Convertir le texte brut en texte brut
      msg = msg.replace(/\n/g, '\n')
               .replace(/<br>/g, '\n')
               .replace(/<b>/g, '')
               .replace(/<\/b>/g, '')
               .replace(/<i>/g, '')
               .replace(/<\/i>/g, '');
      navigator.clipboard.writeText(msg);
      alert("Message copi√© !");
    }

    function sendMail() {
      let msg = document.getElementById("message").value;
      // Convertir le texte brut en texte brut
      msg = msg.replace(/\n/g, '\n')
               .replace(/<br>/g, '\n')
               .replace(/<b>/g, '')
               .replace(/<\/b>/g, '')
               .replace(/<i>/g, '')
               .replace(/<\/i>/g, '');
      let sub = encodeURIComponent("Message Radio Pompier");
      window.location.href = `mailto:?subject=${sub}&body=${encodeURIComponent(msg)}`;
    }

    function resetForm() {
      // R√©initialiser tous les champs de saisie
      document.querySelectorAll("input,select,textarea").forEach(el => {
        el.value = "";
      });

      // R√©initialiser tous les boutons toggle
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // R√©initialiser les compteurs de v√©hicules
      ['vehiculeLeger', 'poidsLourd', 'deuxRoues', 'bus'].forEach(id => {
        let counter = document.getElementById(id);
        if (counter) counter.textContent = '0';
      });

      // R√©initialiser les compteurs de victimes
      ['victimes', 'indemnes', 'UA', 'UR', 'DCD', 'incarcerees', 'intoxiquees', 'impliques'].forEach(id => {
        let counter = document.getElementById(id);
        if (counter) counter.textContent = '0';
      });

      // R√©initialiser les compteurs de moyens pompiers
      ['VSAV', 'FPT', 'EPA', 'chefGroupe', 'vehiculeSpecifique'].forEach(id => {
        let counter = document.getElementById(id);
        if (counter) counter.textContent = '0';
      });

      // R√©initialiser les champs de pr√©cisions des v√©hicules
      ['vehiculeLegerPrecisions', 'poidsLourdPrecisions', 'deuxRouesPrecisions', 'busPrecisions', 'vehiculeSpecifiqueText'].forEach(id => {
        let input = document.getElementById(id);
        if (input) input.value = '';
      });

      // Cacher les sections d√©pliables
      document.querySelectorAll('.sub-container, .hidden').forEach(el => {
        el.classList.add('hidden');
      });

      // R√©initialiser les ic√¥nes de d√©pliage
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.classList.remove('rotated');
      });

      // R√©initialiser les boutons d'expansion
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Hide the nature title
      document.getElementById("selectedNatureTitle").classList.add("hidden");

      // R√©initialiser les variables globales
      selectedNature = "";
      selectedBatiment = "";
      victimsSelected = false;

      // Retourner √† l'√©tape 0
      currentStep = 0;
      document.querySelectorAll(".step").forEach(e => e.classList.add("hidden"));
      document.getElementById("step0").classList.replace("hidden", "active");
      updateProgress();
    }

    function toggleRouteInfo() {
      const routeInfo = document.getElementById('routeInfo');
      const btn = document.getElementById('toggleRouteBtn');
      const icon = btn.querySelector('.toggle-icon');
      
      // Toggle la visibilit√© de la section
      routeInfo.classList.toggle('hidden');
      
      // Toggle l'√©tat du bouton et de l'ic√¥ne
      btn.classList.toggle('active');
      icon.classList.toggle('rotated');
      
      // Forcer l'affichage de la section si elle est ouverte
      if (!routeInfo.classList.contains('hidden')) {
        routeInfo.style.display = 'block';
      }
    }

    function updateRouteFields() {
      const typeRoute = document.getElementById('typeRoute').value;
      const pkField = document.getElementById('pk').parentElement;
      const sensField = document.getElementById('sens').parentElement;
      const nomEchangeurField = document.getElementById('nomEchangeur').parentElement;
      
      // R√©initialiser l'affichage de tous les champs
      pkField.style.display = 'none';
      sensField.style.display = 'none';
      nomEchangeurField.style.display = 'none';
      
      // Afficher les champs appropri√©s selon le type de route
      switch(typeRoute) {
        case 'Autoroute':
          pkField.style.display = 'block';
          sensField.style.display = 'block';
          nomEchangeurField.style.display = 'block';
          break;
        case 'Route nationale':
        case 'Route d√©partementale':
          pkField.style.display = 'block';
          sensField.style.display = 'block';
          break;
        case 'Rocade int√©rieure':
        case 'Rocade ext√©rieure':
          sensField.style.display = 'block';
          break;
      }
    }

    // Modifier l'√©couteur d'√©v√©nements pour le type de route
    document.getElementById('typeRoute').addEventListener('change', function(e) {
      updateRouteFields();
    });

    // Ajouter un √©couteur pour le changement de type de v√©hicule
    document.getElementById('typeVehicule').addEventListener('change', function(e) {
      const codeMatiereContainer = document.getElementById('codeMatiereTMDContainer');
      if (e.target.value === 'V√©hicule poids lourd TMD') {
        codeMatiereContainer.classList.remove('hidden');
      } else {
        codeMatiereContainer.classList.add('hidden');
        document.getElementById('codeMatiereTMD').value = '';
      }
    });

    // Ajouter un √©couteur pour le changement de motif de d√©part
    document.getElementById('motifDepart').addEventListener('change', function(e) {
      // Si on est d√©j√† sur l'√©tape "Je vois", mettre √† jour la s√©lection
      if (currentStep === 2) {
        goToStep(2);
      }
    });

    // Initialiser les √©couteurs d'√©v√©nements
    function initializeRouteEventListeners() {
      const typeRoute = document.getElementById('typeRoute');
      if (typeRoute) {
        typeRoute.addEventListener('change', function(e) {
          updateRouteFields();
        });
      }
      
      const motifDepart = document.getElementById('motifDepart');
      if (motifDepart) {
        motifDepart.addEventListener('change', function(e) {
          if (currentStep === 2) {
            goToStep(2);
          }
        });
      }
    }

    // Modifier window.onload pour inclure l'initialisation des √©couteurs de route
    window.onload = function() {
      setCurrentTime();
      setupGPSInfoReset();
      updateRouteFields();
      initializeRouteEventListeners();
    }

    function toggleLigneDetails() {
      const detailsFields = document.getElementById('ligneDetailsFields');
      const btn = document.getElementById('toggleLigneDetailsBtn');
      const icon = btn.querySelector('.toggle-icon');
      
      detailsFields.classList.toggle('hidden');
      btn.classList.toggle('active');
      icon.classList.toggle('rotated');
    }

    function resetFields() {
      // R√©initialiser tous les champs de saisie
      document.querySelectorAll('input[type="text"], input[type="number"], select, textarea').forEach(el => {
        el.value = '';
      });

      // R√©initialiser tous les boutons toggle
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('selected');
      });

      // R√©initialiser les compteurs de v√©hicules
      ['vehiculeLeger', 'poidsLourd', 'deuxRoues', 'bus'].forEach(id => {
        let input = document.getElementById(id);
        if (input) input.value = '0';
      });

      // Cacher les sections d√©pliables
      document.querySelectorAll('.sub-container, .hidden').forEach(el => {
        el.classList.add('hidden');
      });

      // R√©initialiser les ic√¥nes de d√©pliage
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.classList.remove('rotated');
      });

      // R√©initialiser les boutons d'expansion
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Hide the nature title
      document.getElementById("selectedNatureTitle").classList.add("hidden");
    }

    // Nouvelle fonction pour basculer entre les sections "Je pr√©vois" et "Je fais"
    function togglePrevois() {
      const prevoisFields = document.getElementById("prevoisFields");
      const btn = document.getElementById("togglePrevoisBtn");
      const icon = btn.querySelector(".toggle-icon");
      
      prevoisFields.classList.toggle("hidden");
      btn.classList.toggle("active");
      icon.classList.toggle("rotated");
    }

    // Nouvelle fonction pour basculer les d√©tails des actions
    function toggleActionDetails(el) {
      // Toggle la s√©lection du bouton
      el.classList.toggle("selected");
      
      const target = el.getAttribute("data-target");
      if (target) {
        const details = document.getElementById(target);
        if (details) {
          details.classList.toggle("hidden");
        }
      }
    }

    // Version de l'application
    const APP_VERSION = '1.0.11';

    // Fonction pour v√©rifier les mises √† jour
    function checkForUpdates() {
      const updateStatus = document.getElementById('updateStatus');
      updateStatus.style.display = 'none';
      
      // Forcer le rafra√Æchissement de l'ic√¥ne
      const timestamp = new Date().getTime();
      const iconLinks = document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]');
      iconLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href) {
          link.setAttribute('href', `${href}?v=${timestamp}`);
        }
      });
      
      // D√©tecter si l'utilisateur est sur iOS
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(registration => {
          if (registration) {
            // Cr√©er un timestamp unique pour le cache-busting
            const timestamp = new Date().getTime();
            
            // V√©rifier la version actuelle du service worker
            fetch(`/MRP/sw.js?v=${timestamp}`)
              .then(response => {
                if (response.ok) {
                  return response.text().then(swContent => {
                    const versionMatch = swContent.match(/const APP_VERSION = ['"]([^'"]+)['"]/);
                    const swVersion = versionMatch ? versionMatch[1] : null;
                    
                    if (swVersion && swVersion === APP_VERSION) {
                      // Version √† jour
                      updateStatus.textContent = 'Application √† jour et disponible hors-ligne';
                      updateStatus.style.color = '#28a745';
                      updateStatus.style.display = 'block';
                    } else {
                      // Nouvelle version disponible
                      updateStatus.textContent = 'Une mise √† jour est disponible. Mise √† jour en cours...';
                      updateStatus.style.color = '#ffc107';
                      updateStatus.style.display = 'block';
                      
                      // Vider le cache
                      caches.keys().then(cacheNames => {
                        return Promise.all(
                          cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                      }).then(() => {
                        // Mettre √† jour le service worker
                        registration.update().then(() => {
                          if (isIOS) {
                            // Sur iOS, forcer le rechargement de la page
                            updateStatus.textContent = 'Mise √† jour termin√©e. Rechargement de l\'application...';
                            setTimeout(() => {
                              window.location.reload(true);
                            }, 2000);
                          } else {
                            // Sur les autres plateformes, le service worker se mettra √† jour automatiquement
                            updateStatus.textContent = 'Mise √† jour termin√©e. L\'application se mettra √† jour automatiquement.';
                            setTimeout(() => {
                              updateStatus.style.display = 'none';
                            }, 3000);
                          }
                        });
                      });
                    }
                  });
                } else {
                  throw new Error('Service worker non disponible');
                }
              })
              .catch(error => {
                console.error('Erreur lors de la v√©rification:', error);
                updateStatus.textContent = 'Erreur lors de la v√©rification des mises √† jour';
                updateStatus.style.color = '#dc3545';
                updateStatus.style.display = 'block';
                setTimeout(() => {
                  updateStatus.style.display = 'none';
                }, 3000);
              });
          }
        });
      }
    }

    // V√©rifier automatiquement les mises √† jour au chargement de la page
    window.addEventListener('load', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(registration => {
          if (registration) {
            // V√©rifier les mises √† jour toutes les 5 minutes
            setInterval(() => {
              registration.update();
            }, 5 * 60 * 1000);
          }
        });
      }
    });

    function selectAddressToggle(btn, value) {
      const container = btn.parentElement;
      container.querySelectorAll('.address-toggle-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('adresseConfirmee').value = value;
      updateMessage();
    }

    function getVal(id) {
      const el = document.getElementById(id);
      if (!el) return "";
      if (el.tagName === "SELECT") {
        return el.options[el.selectedIndex].text;
      }
      return el.value;
    }

    function handleEtatCirculation(value) {
      const circulationDetails = document.getElementById('circulationDetails');
      if (value === 'Non alt√©r√©e') {
        circulationDetails.classList.add('hidden');
      } else {
        circulationDetails.classList.remove('hidden');
      }
    }

    function toggleAutreVehicule() {
      const autreVehiculeDetails = document.getElementById('autreVehiculeDetails');
      const btn = document.getElementById('toggleAutreVehiculeBtn');
      const icon = btn.querySelector('.toggle-icon');
      
      autreVehiculeDetails.classList.toggle('hidden');
      btn.classList.toggle('active');
      icon.classList.toggle('rotated');
    }

    function togglePrecisionVictimes() {
      const container = document.getElementById("precisionVictimesContainer");
      const btn = document.getElementById("togglePrecisionVictimesBtn");
      const icon = btn.querySelector('.toggle-icon');
      
      container.classList.toggle("hidden");
      btn.classList.toggle("active");
      icon.classList.toggle("rotated");
    }

    function toggleButtonWithField(button, field, value) {
      const buttons = document.querySelectorAll(`[onclick*="${field}"]`);
      buttons.forEach(btn => {
        if (btn === button) {
          btn.classList.add('selected');
          document.getElementById(field).value = value;
          // Afficher/masquer les d√©tails en fonction de la valeur s√©lectionn√©e
          const detailsContainer = document.getElementById(`${field}Details`);
          if (detailsContainer) {
            if (value === 'non') {
              detailsContainer.classList.remove('hidden');
            } else {
              detailsContainer.classList.add('hidden');
            }
          }
        } else {
          btn.classList.remove('selected');
        }
      });
    }
  </script>
  <script>
    // Enregistrement du Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/MRP/sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }
  </script>
  <script>
    // Initialisation des gestes de swipe
    const container = document.querySelector('.container');
    const hammer = new Hammer(container);

    // Configuration des gestes
    hammer.get('swipe').set({ direction: Hammer.DIRECTION_HORIZONTAL });

    // Variables pour suivre le swipe
    let isSwiping = false;
    let currentStepElement = null;

    // Gestion des √©v√©nements de swipe
    hammer.on('swipeleft', function() {
      if (currentStep < 6 && !isSwiping) {
        isSwiping = true;
        currentStepElement = document.querySelector(`#step${currentStep}`);
        currentStepElement.classList.add('swiping-left');
        
        setTimeout(() => {
          goToStep(currentStep + 1);
          const newStepElement = document.querySelector(`#step${currentStep + 1}`);
          newStepElement.classList.add('swipe-in-left');
          
          setTimeout(() => {
            currentStepElement.classList.remove('swiping-left');
            newStepElement.classList.remove('swipe-in-left');
            isSwiping = false;
          }, 300);
        }, 300);
      }
    });

    hammer.on('swiperight', function() {
      if (currentStep > 0 && !isSwiping) {
        isSwiping = true;
        currentStepElement = document.querySelector(`#step${currentStep}`);
        currentStepElement.classList.add('swiping-right');
        
        setTimeout(() => {
          goToStep(currentStep - 1);
          const newStepElement = document.querySelector(`#step${currentStep - 1}`);
          newStepElement.classList.add('swipe-in-right');
          
          setTimeout(() => {
            currentStepElement.classList.remove('swiping-right');
            newStepElement.classList.remove('swipe-in-right');
            isSwiping = false;
          }, 300);
        }, 300);
      }
    });
  </script>
</body>
</html>
